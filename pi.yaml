- !Image
  name: test
  from: !DockerImage alpine:3.4
  repository: reg.local/metricslog.test
  provision-with: !AnsibleTasks
    - raw: apk add --no-cache python3
    - pip: name={{item}} executable=pip3 extra_args='--no-cache-dir'
      with_items:
        - pytest==3.0.4
        - flake8==3.2.1

- !Service
  name: elasticsearch
  image: !DockerImage elasticsearch:5.1.1
  ports:
    - !Expose { port: 9200, as: 9200 }
    - !Expose { port: 9300, as: 9300 }

- !ShellCommand
  name: test
  description: Test and lint codebase
  params:
    - !Argument {name: tests, default: metricslog}
  image: test
  eval: >
    py.test -q --tb=native {{tests}}
    && flake8 --max-line-length=80 metricslog
    && echo "Lint - ok"

- !ShellCommand
  name: logstash-dev
  network-name: logstash
  image: !DockerImage logstash:5.0.1
  volumes:
    - !LocalPath { from: examples/conf/logstash.conf, to: /etc/logstash/conf.d/logstash.conf }
  eval: logstash -f /etc/logstash/conf.d/logstash.conf

- !Image
  name: temp
  from: !DockerImage ubuntu:xenial
  repository: reg.local/metricslog.temp
  provision-with: !AnsibleTasks
    - raw: apt-get update
    - raw: apt-get install -y rsyslog-elasticsearch python3-pip
    - raw: rm -rf /var/lib/apt/lists/*
    - raw: LANG=C pip3 install --no-cache-dir --disable-pip-version-check python-logstash

- !ShellCommand
  name: example-logstash
  image: temp
  eval: python3 -m examples.logstash

- !ShellCommand
  name: example-syslog
  image: temp
  volumes:
    - !LocalPath { from: examples/conf/rsyslog.conf, to: /etc/rsyslog.conf }
    - !LocalPath { from: ., to: /src }
  environ:
    PYTHONPATH: /src
  eval: >
    /usr/sbin/rsyslogd -f /etc/rsyslog.conf -N1 &&
    /usr/sbin/rsyslogd -f /etc/rsyslog.conf &&
    python3 -m examples.syslog
